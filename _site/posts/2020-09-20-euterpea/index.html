<!doctype html><html><head><title>Chorale | jxxcarlson</title><meta charset="utf-8"><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.1/highlight.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.1/languages/elm.min.js"></script><script>hljs.initHighlightingOnLoad();</script><link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.1/styles/default.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Open+Sans|Proza+Libre|Inconsolata" rel="stylesheet" type="text/css"></head><body><div class="header-logo"><img alt="Author's blog" src="/img/logo.png" width="35"></div><div class="navigation"><ul><li><a href="/about">Home</a></li><li><a href="/posts">Posts</a></li><li><a href="/apps">Apps</a></li><li><a href="/contact">Contact</a></li></ul></div><div class="sidebar"></div><div class="sidebar2"></div><div class="content"><h1>Chorale</h1><div class="post-metadata"><span>2020-09-20</span><span>•</span><a href="/tags/code">code</a><a href="/tags/rc">rc</a><a href="/tags/fp">fp</a><a href="/tags/music">music</a></div><div class="markdown"><p>This composition is an infinite minimalist chorale in four parts written in Haskell
using the Euterpea library.  It is useful to compute its <em>cycle length</em>: the smallest number of beats after which the piece repeats itself. This turns out to be 156780 beats. At a metronome marking
of 120 beats per minute, that means 21 hours 46 minutes and 30 seconds
 of music.  Whew!</p>
<p>With the cycle length in hand, one
can construct a one-cycle finite version of the piece.
It can then be exported to MIDI
using the Haskell code <code>writeMidi "chorale.midi" chorale'</code>.
The result is a 1.1 megabyte MIDI file. Yikes! Importing the file into an
program such as Logic Pro, one can produce
a playable audio file of reasonable size.  To do this, I first deleted everything
after measure 200, then exported the resulting data to a .WAV file.  This file
was converted to mp3 and uploaded here:</p>
<audio controls="">
  <source src="/audio/chorale-200.mp3" type="audio/mpeg">
  Your browser does not support the audio element.
</audio>

<p>I plan to work further on this composition.  At the very least,
the phrases need to be shaped so that they start off softly,
then crescendo, and finally decrescendo near the end of the phrase.
A decrescendo to pianissimo trailing off into silence at the end
would also be good.  More generally, the ending of the 3 minute, 34
second clip from the “full” 21+ hour cycle of the infinite piece is
abrupt and unsatisfactory.</p>
<p>An interesting technical point is whether there is a way of streaming
midi output from Haskell running on a computer to a MIDI device that would
perform the piece in some esthetically satisfactory way, e.g, with decent
sounding instruments.</p>
<p>Whether using an audio program for post-processing or using a streaming
MIDI solution, I think it would be good also to have a touch of reverb so
that the music would blend a bit and possibly sound more mysterious.</p>
<h3 id="code-haskell-">Code (Haskell)</h3>
<pre><code>module Chorale where

import Euterpea

--- THE COMPOSITION ---

-- Infinite version:
chorale :: InstrumentName -&gt; Music Pitch
chorale player =  instrument player $ bass :=: tenor :=: tenor2 :=: solo

-- Finite version with instrument = clarinet
chorale' :: Music Pitch
chorale' = bassLine' :=: tenorLine' :=: tenorLine2' :=: soloLine'

-- Examples:
-- &gt; playDev 2 $ chorale Clarinet            -- play the infinite version
-- &gt; playDev 2 chorale'                      -- play the finite version
-- &gt; writeMidi   "chorale.midi" 'chorale'      -- save to a MIDI file

--- CONSTRUCTION OF THE INFINITE VERSION ---

solo :: Music Pitch
solo = forever $ soloLine

tenor :: Music Pitch
tenor = forever $ tenorLine

tenor2 :: Music Pitch
tenor2 = forever $ tenorLine2

bass :: Music Pitch
bass = forever $ bassLine


--- CONSTRUCTION OF THE PARTS ---

-- The bass line
bassNote = d 1
bassNote' = ds 1
bassNote'' = e 1
bassNote''' = f 1
bassLine = line $ [bassNote 6, rest 3, bassNote' 3, rest 3, bassNote'' 3
                    , rest 2, bassNote''' 4, rest 1 , bassNote 7, rest 4]

-- The tenor
tenorNote = a 1
tenorNote' = c 2
tenorNote'' = d 2
tenorLine = line $ map (rescale (1/2)) [rest 2, tenorNote 8, rest 3
                  , tenorNote' 4, tenorNote'' 5, rest 4]

-- The second tenor
tenorLine2 = rest 7 :+: f 1 4 :+: c 2 4

-- The solo
soloMotif = line $ [a 2 1, d 3 1, c 3 2, f 3 2, e 3 4, rest 2]
soloMotif' = rest 9 :+: soloMotif :+: transpose 3 soloMotif
soloLine = soloMotif' :+: transpose 7 soloMotif' :+: rest 1


--- CONSTRUCTION OF THE PARTS FOR THE FINITE VERSION ---

-- Compute the length of each line
lSolo = ilength soloLine
lTenor = ilength tenorLine
lTenor2 = ilength tenorLine2
lBass = ilength bassLine

-- Compute the cycle length as the
-- least common multiple of the lengths
-- of the individual lines.
cycleLength = lcm_ [lSolo, lTenor, lTenor2, lBass]

-- Compute the number of times each line of
-- music must be repeated so as to have
-- the given cycle length.
nSolo = cycleLength `div` lSolo
nTenor = cycleLength `div` lTenor
nTenor2 = cycleLength `div` lTenor2
nBass = cycleLength `div` lBass

-- Construct one cycle of the chorale
soloLine', tenorLine', tenorLine2', bassLine' :: Music Pitch
soloLine' = mrepeat nSolo soloLine
tenorLine' = mrepeat nTenor tenorLine
tenorLine2' = mrepeat nTenor2 tenorLine2
bassLine' = mrepeat nBass bassLine

-- Verify:
-- &gt; map ilength [bassLine', tenorLine', tenorLine2', soloLine']
--   [156780,156780,156780,156780]



--- HELPER FUNCTIONS ---

-- Compute the length of a melody in beats
mlength :: Music Pitch -&gt; Dur
mlength mp =
    case mp of
        (Prim (Note d p)) -&gt; d
        Prim (Rest d) -&gt; d
        m1 :+: m2 -&gt; mlength m1 + mlength m2
        m1 :=: m2 -&gt; maximum [mlength m1, mlength m2]
        Modify control m -&gt; mlength m

-- Compute the length of a melody in beats, but convert
-- to an integer.  Oops, we loose fractional beats,
-- if there are any.
ilength :: Music Pitch -&gt; Int
ilength mp = round $ mlength mp

-- Repeat the music m n times
mrepeat :: Int -&gt; Music a -&gt; Music a
mrepeat 0 m = rest 0
mrepeat n m = m :+: mrepeat (n - 1) m

-- Least common multiple of a list of integers.
lcm_ :: [Int] -&gt; Int
lcm_ [] = 1
lcm_ (x:[]) = x
lcm_ (x:xs) = lcm x (lcm_ xs)

-- Change the duration of each note by a factor
rescale :: Dur -&gt; Music Pitch -&gt; Music Pitch
rescale factor mp =
    case mp of
        (Prim (Note d p)) -&gt; Prim (Note (factor * d) p)
        Prim (Rest d) -&gt; Prim (Rest (factor * d))
        m1 :+: m2 -&gt; rescale factor m1 :+: rescale factor m2
        m1 :=: m2 -&gt; rescale factor m1 :=: rescale factor m2
        Modify control m -&gt; Modify control (rescale factor m)
</code></pre><h2 id="references">References</h2>
<ul>
<li><a href="http://euterpea.com/tutorials/">Euterpea Tutorials</a></li>
</ul>
</div></div><div class="footer"><div style="float: left; padding-left: 12px">Built with Elmstatic</div><div class="link"><a href="https://booklib.io">Booklib.io</a></div><div class="link"><a href="https://markdown.minilatex.app/">Markdown.minilatex.app</a></div><div class="link"><a href="https://markdown.minilatex.app/">MathMarkdown Demo</a></div><div class="link"><a href="https://demo.minilatex.app/">Minilatex Demo</a></div><div class="link"><a href="https://reader.minilatex.app/">Minilatex Reader</a></div><div class="link"><a href="https://knode.io">knode.io</a></div><div class="link"><svg width="16" height="16" viewbox="0 0 16 16"><path fill="#fff" d="
M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z
            "></path></svg><a href="https://github.com/jxxcarlson/">GitHub</a></div></div><link href="/styles.css" rel="stylesheet" type="text/css"><style>body {
    padding:0px;
    margin:0px;
    background-color:#ffffff;
    color:#363636;
    font-family:Open Sans, Arial, sans-serif;
    font-size:15px;
    line-height:1.4em;
}

a {
    color:#1552b5;
    text-decoration:none;
}

code {
    font-family:Inconsolata, monospace;
}

pre  code {
    overflow-x:scroll !important;
}

h1, h2, h3, h4, h5, h6 {
    font-family:Proza Libre, Helvetica, sans-serif;
    line-height:1.1em;
}

h1 {
    font-size:2.66667em;
    margin-bottom:2.0202rem;
}

h2 {
    font-size:2em;
    margin-bottom:1.61616rem;
}

h3 {
    font-size:1.33333em;
    margin-bottom:1.21212rem;
}

h4 {
    font-size:1.2em;
    margin-bottom:0.80808rem;
}

h5, h6 {
    font-size:1em;
    margin-bottom:0.60606rem;
}

p {
    margin:auto auto 1.5rem;
}

small {
    font-size:65%;
}

.header-logo {
    padding-top:6px;
    text-align:center;
    background-color:#666666;
}

@media only screen and (min-width: 600px) {
    .header-logo {
        text-align:left;
    border-bottom:2px solid #3c8765;
    }
}

.navigation {
    text-align:center;
    border-bottom:2px solid #3c8765;
    background-color:#666666;
    color:#ffffff;
    padding:10px;
    margin-top:-20px;
}

@media only screen and (min-width: 600px) {
    .navigation {
        margin-top:0px;
    padding:0px;
    text-align:right;
    }
}

.navigation  ul {
    margin:0px;
    padding:0px;
}

@media only screen and (min-width: 600px) {
    .navigation  ul {
        line-height:50px;
    }
}

.navigation  li {
    display:inline-block;
    margin-right:20px;
}

.navigation  a {
    color:#ffffff;
    text-decoration:none;
}

.content {
    max-width:100vw;
}

@media only screen and (min-width: 600px) {
    .content {
        max-width:600px;
    }
}

.footer {
    text-align:center;
    border-top:2px solid #000000;
    background-color:#666666;
    color:#ffffff;
}

@media only screen and (min-width: 600px) {
    .footer {
        line-height:80px;
    text-align:right;
    }
}

@media only screen and (min-width: 600px) {
    .footer  .link {
        display:inline-block;
    margin-right:20px;
    }
}

.footer  a {
    color:#ffffff;
    text-decoration:none;
}

.footer  svg {
    padding-right:5px;
    vertical-align:baseline;
}

.post-metadata {
    margin-top:-0.5em;
    margin-bottom:2em;
}

.post-metadata  a, .post-metadata  span {
    display:inline-block;
    margin-right:5px;
}

.post-metadata  a {
    border:1px solid #e0e0e0;
    border-radius:3px;
    background-color:#f2f2f2;
    padding-left:5px;
    padding-right:5px;
}</style></body></html>